name: Build Lemuroid Bundled APK

on:
  workflow_dispatch: # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Make Gradle executable
      run: chmod +x ./gradlew

    - name: Build Bundled Release APK
      run: |
        ./gradlew :bundled-cores:assembleBundleRelease
        ./gradlew :lenuroid-app:assembleFreeBundleRelease
      # 关键命令分两步：
      # 1. 先单独编译 'bundled-cores' 模块的 'bundleRelease' 版本，生成所需的核心库。
      # 2. 再编译 'lenuroid-app' 模块的 'freeBundleRelease' 版本，此时它就能找到上一步生成的依赖了。
      # 我们编译Release版，这样得到的APK更优化，且无需处理Debug签名问题。

    - name: Find and Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: Lemuroid-Free-Bundle-Release-APK
        path: |
          lenuroid-app/build/outputs/apk/freeBundle/release/*.apk
          lenuroid-app/build/outputs/bundle/freeBundleRelease/*.aab
        # 上传找到的APK文件。
        # 由于构建的是Release版，路径是 'freeBundle/release/'。
        # 同时也会尝试上传Android App Bundle (.aab) 文件，如果存在的话。
